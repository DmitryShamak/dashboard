<div class="template-block-cover ticket-wrapper">
	<div class="content-cover">
        <div class="clearfix control-wrapper">
            <div class="status-control pull-left" data-bind="foreach: statuslist">
                <div class="control-btn pull-left text-center" data-bind="text: title, click: $root.setStatus, visible: $root.notActive($index)"></div>
            </div>
            <div class="pull-right edit-btn" data-bind="click: toggleEdit">Edit<span class="edit-icon"></span></div>
        </div>
        <form method="post">
            <div class="text-left">
                <div> 
                    <h3>Name: <span>{{obj.name}}</span></h3>
                </div>
                <div>
                    <h3>Project: <a href="/board/{{data.project}}">{{obj.project}}</a></h3>
                </div>
                <div>
                    <h3>Description: </h3>
                    <p data-bind="ifnot: editable"><span>{{data.description}}</span></p>
                    <p data-bind="if: editable"><textarea name="description" rows="4">{{obj.description}}</textarea></p>
                </div>
                <div>
                    <h3>Status: 
                        <span id="status" data-bind="text: $root.getStatusTitle($root.activeStatus)"></span>
                        <span data-bind="visible: false">
                            <input name="status" value="{{obj.status}}"/>
                        </span>
                    </h3>
                </div>
                <div>
                    <h3>Priority: 
                        <span data-bind="ifnot: editable" id="priority">{{obj.priority}}</span>
                        <span data-bind="if: editable">
                            <input style="width: 20px;" class="text-center" name="priority" value="{{obj.priority}}"/>
                        </span>
                    </h3>
                </div>
                <div>
                    <h3>Reporter: <span>{{data.reporter}}</span></h3>
                </div>
                <div>
                    <h3>Assignee: <span data-bind="ifnot: editable">
                        <span data-bind="text: $root.assignee()"></span>
                    </span></h3>
                    <p data-bind="if: editable">
                        <input data-bind="value: $root.assignee()" type="text" style="display: none;" name="assignee" placeholder="Assignee" />
                        <select data-bind="options: $root._filterUserList(userlist), event: {change: $root.onChange}"></select>
                    </p>
                </div>
            </div>
            <p data-bind="if: editable" class="text-left">
                <button formaction="/updateticket/{{obj.name}}">Save</button>
                <button formaction="/removeticket/{{obj.name}}">Delete</button>
            </p>
        </form>
        <div class="comments" data-bind="ifnot: editable">
            <h3>Comments:</h3>
            <div>
                <textarea data-bind="value: comment" style="width: 100%; height: 50px; resize: none;" name="comment" placeholder="Comment..."></textarea>
                <p class="text-center"><button data-bind="click: submitComment">Submit Comment</button></p>
            </div>
            <div class="comments-wrapper text-left">
                {% for comment in obj.comments %}
                <p>
                    <span data-bind="text: getDate('{{comment.date}}')"></span> <span>{{comment.user}}</span>: <span>{{comment.comment}}</span>
                </p>
                {% endfor %}
            </div>
        </div>
	</div>
</div>
<script>
    function AppViewModel() {
        var self = this;
     
        self.editable = ko.observable(false);
        self.assignee = ko.observable("{{obj.assignee}}");
        self.currProject = "{{obj.project}}";
        self.userlist = ko.observable([]);
        self.activeStatus = ko.observable({{obj.status}});
        self.comment = ko.observable("");

        self.submitComment = function() {
            $.post("/addticketcomment/{{obj.name}}", {comment: self.comment()}, function(res) {
                res = JSON.parse(res);
                if(!res.error)
                    $('.comments-wrapper').append("<p><span>"+self.getDate(res.date)+" "+res.user+"</span>: <span>"+res.comment+"</span></p>");
                self.comment("");
            });
        };

        self.getDate = function(time) {
            var date = new Date();
            time != "" ? date.setTime(time.toString()) : date;
            console.log(date);
            return (date.getFullYear() + "." + (date.getMonth()+1) + "." + date.getDate());
        };

        self.notActive = function(index) {
            var res = index() != self.activeStatus();

            if(index() == 4 && self.activeStatus() != 3) {
                res = false;
            }

            return res;
        };

        self.onChange = function(obj, e) {
            self.assignee(e.target.value);
        };

        var getAssigneeIndex = function(id) {
            var index = -1,
                i = 0;
            for(var key in self.userlist()) {
                if(getAssigneeName(self.userlist()[key]) == self.assignee()) {
                    index = i;
                    break;
                }
                i++;
            }

            return index;
        };

        var getAssigneeName = function(obj) {
            return (obj ? (obj.firstname + " " + obj.lastname) : "No Assignee");
        } 

        self.setCurrAssigneeName = function() {
            var index = getAssigneeIndex(self.assignee());
            var assignee = getAssigneeName(self.userlist()[index]);
            self.assignee(assignee);            
        };

        self._filterUserList = function(arr) {
            var list = arr();
            var result = [],
                assignee = "No Assignee";

            for(var key in list) {
                result.push(getAssigneeName(list[key]));
            }

            var index = getAssigneeIndex(self.assignee());
            
            if(index+1) {
                assignee = result[index];
                result.splice(index, 1);
            } else {
               assignee = self.assignee();
            }

            result = [].concat([assignee], result);

            return result;
        };

        self.getStatusTitle = function(ind) {
            var title = (self.statuslist()[ind()]) ? self.statuslist()[ind()].title : "pending...";
            return title;
        };

        self.setStatus = function(status) {
            var statusIndex = status.index;

            $.post("/updateticket/{{obj.name}}", {status: statusIndex}, function(res) {
                self.activeStatus(statusIndex);
            });
        };

        self.getStatusList = function() {
            var url = "/getstatuslist/" + self.currProject;
            $.get(url, function(res) {
                self.statuslist(JSON.parse(res).list);
            });

            return false;
        };

        self.getUserList = function() {
            var url = "/getuserlist";
            $.get(url, function(res) {
                self.userlist(res);

                self.setCurrAssigneeName();
            });
        };

        self.statuslist = ko.observable([]);

        self.getStatusList();
        self.getUserList();

        self.toggleEdit = function() {
            self.editable(!self.editable())
        }

    }
     
    ko.applyBindings(new AppViewModel());
</script>