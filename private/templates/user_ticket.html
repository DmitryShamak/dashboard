<div class="template-block-cover ticket-wrapper">
	<div class="content-cover">
        <div class="clearfix control-wrapper">
            <div class="status-control pull-left" data-bind="foreach: statuslist">
                <div class="control-btn pull-left text-center" data-bind="text: title, click: $root.setStatus, visible: $root.notActive($index)"></div>
            </div>
            <div class="pull-right edit-btn" data-bind="click: toggleEdit">Edit<span class="edit-icon"></span></div>
        </div>
        <form method="post">
            <div class="text-left">
                <div> 
                    <h3>Name: <span>{{data.name}}</span></h3>
                    <p data-bind="if: editable"><input type="text" placeholder="Ticket name" name="name" value="{{data.name}}" /></p>
                </div>
                <div>
                    <h3>Project: <a href="/user_board/{{data.project}}">{{data.project}}</a></h3>
                </div>
                <div>
                    <h3>Description: </h3>
                    <p data-bind="ifnot: editable"><span>{{data.description}}</span></p>
                    <p data-bind="if: editable"><textarea name="description" rows="4">{{data.description}}</textarea></p>
                </div>
                <div>
                    <h3>Status: 
                        <span id="status" data-bind="text: $root.getStatusTitle($root.activeStatus)"></span>
                    </h3>
                </div>
                <div>
                    <h3>Priority: 
                        <span data-bind="ifnot: editable" id="priority">{{data.priority}}</span>
                        <span data-bind="if: editable">
                            <input style="width: 20px;" class="text-center" name="priority" value="{{data.priority}}"/>
                        </span>
                    </h3>
                </div>
                <div>
                    <h3>Assignee: <span data-bind="ifnot: editable">
                        <span data-bind="text: $root.assignee().name"></span>
                    </span></h3>
                    <p data-bind="if: editable">
                        <input data-bind="value: $root.assignee().id" type="text" style="display: none;" name="assignee" placeholder="Assignee" />
                        <select data-bind="options: $root._filterUserList(userlist), optionsText: 'name', optionsValue: 'id', event: {change: $root.onChange}"></select>
                    </p><!-- Next change to dropdown -->
                </div>
            </div>
            <p data-bind="if: editable" class="text-left">
                <button formaction="/updateticket/{{data.name}}">Save</button>
                <button formaction="/removeticket/{{data.name}}">Delete</button>
            </p>
        </form>
        <div class="comments" data-bind="ifnot: editable">
            <h3>Comments</h3>
            <div class="wrapper text-left">
                <p>Dmitry: Best ticket ever.</p>
            </div>
        </div>
	</div>
</div>
<script>
    function AppViewModel() {
        var self = this;
     
        self.editable = ko.observable(false);
        self.assignee = ko.observable({id: "{{data.assignee}}", name: "No Assignee"});
        self.currProject = "{{data.project}}";
        self.userlist = ko.observable([]);
        self.activeStatus = ko.observable({{data.status}});

        self.notActive = function(index) {
            var res = index() != self.activeStatus();

            if(index() == 4 && self.activeStatus() != 3) {
                res = false;
            }

            return res;
        };

        self.onChange = function(obj, e) {
            var assignee = self.assignee();
            assignee.id = e.target.value;
            self.assignee(assignee);
        };

        var getAssigneeIndex = function(id) {
            var index = -1,
                i = 0;
            for(var key in self.userlist()) {
                if(self.userlist()[key].email == self.assignee().id) {
                    index = i;
                    break;
                }
                i++;
            }

            return index;
        }

        var getAssigneeName = function(obj) {
            return (obj ? (obj.firstname + " " + obj.lastname) : "No Assignee");
        } 

        self.setCurrAssigneeName = function() {
            var index = getAssigneeIndex(self.assignee().id);
            var assignee = self.assignee();
            assignee.name = getAssigneeName(self.userlist()[index]);
            self.assignee(assignee);            
        };

        self._filterUserList = function(arr) {
            var list = arr();
            var result = [],
                assignee;

            for(var key in list) {
                result.push({
                    name: getAssigneeName(list[key]),
                    id: list[key].email
                });
            }

            var index = getAssigneeIndex(self.assignee().id);
            
            if(index+1) {
                assignee =  {name: result[index].name, id: result[index].id};
                result.splice(index, 1);
            } else {
               assignee =  self.assignee();
            }

            result = [].concat(assignee, result);

            return result;
        };

        self.getStatusTitle = function(ind) {
            var title = (self.statuslist()[ind()]) ? self.statuslist()[ind()].title : "pending...";
            return title;
        };

        self.setStatus = function(status) {
            var statusIndex = status.index;

            $.post("/updateticket/{{data.name}}", {status: statusIndex}, function(res) {
                self.activeStatus(statusIndex);
            });
        };

        self.getStatusList = function() {
            var url = "/getstatuslist/" + self.currProject;
            $.get(url, function(res) {
                self.statuslist(JSON.parse(res).list);
            });

            return false;
        };

        self.getUserList = function() {
            var url = "/getuserlist";
            $.get(url, function(res) {
                self.userlist(res);

                self.setCurrAssigneeName();
            });
        };

        self.statuslist = ko.observable([]);

        self.getStatusList();
        self.getUserList();

        self.toggleEdit = function() {
            self.editable(!self.editable())
        }

    }
     
    ko.applyBindings(new AppViewModel());
</script>